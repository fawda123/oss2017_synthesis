---
title: "Exploratory plots of restoration activities in TB"
output: 
  html_document:
    keep_md: yes
    code_folding: hide
    toc: true
    toc_float: true
---

```{r message = F, warning = F, results = 'hide'}
library(tidyverse)
library(readxl)
library(ggmap)
library(lubridate)
library(geosphere)
library(stringi)
library(tibble)
knitr::knit('tbrest.Rmd', tangle = TRUE)
file.copy('tbrest.R', 'R/tbrest.R', overwrite = TRUE)
file.remove('tbrest.R')

# source R files
source('R/get_chg.R')
source('R/get_clo.R')
source('R/get_cdt.R')
source('R/get_brk.R')
```

## Restoration and water quality data

```{r warning = F, message = F}  
data(restdat)
data(reststat)
data(wqdat)
data(wqstat)
```

Habitat restoration projects:
```{r}
head(restdat)
```
Locations of habitat restoration projects:
```{r}
head(reststat)
```
Water quality data:
```{r}
head(wqdat)
```
Locations of water quality sites:
```{r}
head(wqstat)
```

## Distance to restoration sites {.tabset}

```{r}
wqmtch <- get_clo(restdat, reststat, wqstat, resgrp = 'top', mtch = 10)
head(wqmtch)
```

### Closest 
```{r message = F, warning = F, fig.width = 7, fig.height = 8}
## 
# plots

# combine lat/lon for the plot
toplo <- wqmtch %>% 
  left_join(wqstat, by = 'stat') %>% 
  left_join(reststat, by = 'id') %>% 
  rename(
    `Restoration\ngroup` = resgrp,
    `Distance (dd)` = dist
  )
    
# restoration project grouping column
resgrp <- 'top'
restall <- left_join(restdat, reststat, by = 'id')
names(restall)[names(restall) %in% resgrp] <- 'Restoration\ngroup'

# extent
ext <- make_bbox(wqstat$lon, wqstat$lat, f = 0.1)
map <- get_stamenmap(ext, zoom = 12, maptype = "toner-lite")

# base map
pbase <- ggmap(map) +
  theme_bw() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  ) +
  geom_point(data = restall, aes(x = lon, y = lat, fill = `Restoration\ngroup`), size = 4, pch = 21) +
  geom_point(data = wqstat, aes(x = lon, y = lat), size = 2)

# closest
toplo1 <- filter(toplo, rnk %in% 1)

pbase + 
  geom_segment(data = toplo1, aes(x = lon.x, y = lat.x, xend = lon.y, yend = lat.y, alpha = -`Distance (dd)`, linetype = `Restoration\ngroup`), size = 1)
```

### Closest five
```{r message = F, warning = F, fig.width = 7, fig.height = 8}
# closest five
toplo2 <- filter(toplo, rnk %in% c(1:5))

pbase + 
  geom_segment(data = toplo2, aes(x = lon.x, y = lat.x, xend = lon.y, yend = lat.y, alpha = -`Distance (dd)`, linetype = `Restoration\ngroup`), size = 1)
```

### Closest ten
```{r message = F, warning = F, fig.width = 7, fig.height = 8}
# closest twenty
toplo3 <- filter(toplo, rnk %in% c(1:10))

pbase + 
  geom_segment(data = toplo3, aes(x = lon.x, y = lat.x, xend = lon.y, yend = lat.y, alpha = -`Distance (dd)`, linetype = `Restoration\ngroup`), size = 1)
```

## Summarizing effects of restoration projects

Get weighted average of project type, treatment (before, after) of salinity for all wq station, restoration site combinations.
```{r}
salchg <- get_chg(wqdat, wqmtch, statdat, restdat, wqvar = 'sal', yrdf = 5)
head(salchg)
```

Get conditional probability distributions for the restoration type, treatment effects, **salinity** as first child node in network. 
```{r}
wqcdt <- get_cdt(salchg, 'resgrp', 'trt')
head(wqcdt)
```

Discretization of salinity conditional probability distributions: 
```{r fig.height = 5, fig.width = 7, message = F, warning = F}
salbrk <- get_brk(wqcdt, qts = c(0.33, 0.66), 'resgrp', 'trt')
salbrk
```

A plot showing the breaks:
```{r fig.height = 5, fig.width = 7, message = F, warning = F}
toplo <- select(wqcdt, -data, -crv) %>% 
  unnest
ggplot(toplo, aes(x = cval, y = cumest, group = trt)) + 
  geom_line(aes(colour = trt)) + 
  geom_segment(data = salbrk, aes(x = qts, y = 0, xend = qts, yend = brk, linetype = factor(clev), colour = trt)) +
  geom_segment(data = salbrk, aes(x = min(toplo$cval), y = brk, xend = qts, yend = brk, linetype = factor(clev), colour = trt)) +
  facet_grid(~ resgrp) +
  theme_bw()
```

Get conditional probability distributions for the restoration type, treatment effects, salinity levels, **chlorophyll** as second child node in network. 
```{r eval = T, fig.height = 4, fig.width = 8, message = F, warning = F}
# get chlorophyll changes
chlchg <- get_chg(wqdat, wqmtch, statdat, restdat, wqvar = 'chla', yrdf = 5)
  
# merge with salinity, bet salinity levels
salbrk <- salbrk %>% 
  group_by(resgrp, trt) %>% 
  nest(.key = 'levs')
allchg <- full_join(chlchg, salchg, by = c('resgrp', 'trt', 'stat')) %>% 
  rename(
    salev = cval.y, 
    cval = cval.x
  ) %>% 
  group_by(resgrp, trt) %>% 
  nest %>% 
  left_join(salbrk, by = c('resgrp', 'trt')) %>% 
  mutate(
    sallev = pmap(list(data, levs), function(data, levs){

      out <- data %>% 
        mutate(
          salev = cut(salev, breaks = c(-Inf, levs$qts, Inf), labels = c('lo', 'md', 'hi')),
          salev = as.character(salev)
        )
      
      return(out)
      
    })
  ) %>% 
  select(-data, -levs) %>% 
  unnest
  
chlcdt <- get_cdt(allchg, 'resgrp', 'trt', 'salev')
chlbrk <- get_brk(chlcdt, c(0.33, 0.66), 'resgrp', 'trt', 'salev')
chlbrk %>% 
  print(n = nrow(.))
```

A plot showing the breaks:
```{r fig.height = 7, fig.width = 8, message = F, warning = F}
toplo <- select(chlcdt, -data, -crv) %>% 
  unnest
ggplot(toplo, aes(x = cval, y = cumest, group = trt)) + 
  geom_line(aes(colour = trt)) + 
  geom_segment(data = chlbrk, aes(x = qts, y = 0, xend = qts, yend = brk, linetype = factor(clev), colour = trt)) +
  geom_segment(data = chlbrk, aes(x = min(toplo$cval), y = brk, xend = qts, yend = brk, linetype = factor(clev), colour = trt)) +
  facet_grid(salev ~ resgrp, scales = 'free_x') +
  theme_bw()
```


